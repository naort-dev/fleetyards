image: fleetyards/base:2.6.6

stages:
  - prep
  - test
  - post-test
  - deploy

cache: &global_cache
  key: fleetyards-cache
  paths:
    - node_modules/
    - public/
    - vendor/bundle/
  policy: pull

.ruby_template:
  variables:
    BUNDLE_PATH: vendor/bundle
  before_script:
    - bundle config path vendor/bundle
    - bundle install
    - mkdir -p log

.js_test_template:
  before_script:
    - yarn --frozen-lockfile

.ruby_test_template:
  extends: .ruby_template
  services:
    - postgres:12.2-alpine
  variables:
    RAILS_ENV: test
    DATABASE_URL: postgresql://root:root@127.0.0.1:5432/fleetyards_test
    DATABASE_HOST: 127.0.0.1
    DATABASE_USER: root
    POSTGRES_DB: fleetyards_test
    POSTGRES_USER: root
    POSTGRES_PASSWORD: ""
    POSTGRES_HOST_AUTH_METHOD: trust

.e2e_template:
  extends: .ruby_test_template
  image: fleetyards/ci:2.6.6
  services:
    - redis:latest
    - docker.elastic.co/elasticsearch/elasticsearch:7.5.2
  variables:
    DATABASE_URL: postgresql://root:root@127.0.0.1:5432/fleetyards
    TEST_SEEDS: 1
    RAILS_ENV: ci
    ON_SUBDOMAIN: 1
    RAILS_SERVE_STATIC_FILES: 1
    DISABLE_DATABASE_ENVIRONMENT_CHECK: 1
    CYPRESS_BASE_URL: http://localhost:8270
    CYPRESS_CI: 1
    APP_DIR: .
    PORT: 8270
    cluster.name: fleetyards-test-cluster
    xpack.security.enabled: 0
    transport.host: localhost
    network.host: 127.0.0.1
    http.port: 9200
    discovery.type: single-node
    ES_JAVA_OPTS: -Xms512m -Xmx512m

yarn:
  stage: prep
  cache:
    <<: *global_cache
    paths:
      - node_modules/
    policy: pull-push
  script:
    - yarn --frozen-lockfile
  only:
    changes:
      - .gitlab-ci.yml
      - package.json
      - yarn.lock
      - .npmrc

bundle:
  stage: prep
  cache:
    <<: *global_cache
    paths:
      - vendor/bundle/
    policy: pull-push
  script:
    - bundle config path vendor/bundle
    - bundle install
  only:
    changes:
      - .gitlab-ci.yml
      - Gemfile
      - Gemfile.lock
      - .ruby-version

ruby audit:
  extends: .ruby_template
  stage: test
  script:
    - bundle exec bundle-audit update
    - bundle exec bundle-audit check

yarn audit:
  extends: .js_test_template
  stage: test
  script:
    - yarn audit

rubocop:
  extends: .ruby_template
  stage: test
  script:
    - bundle exec rubocop --format progress

js-lint:
  extends: .js_test_template
  stage: test
  script:
    - yarn run lint:js

vue-lint:
  extends: .js_test_template
  stage: test
  script:
    - yarn run lint:vue

style-lint:
  extends: .js_test_template
  stage: test
  script:
    - yarn run lint:style

js tests:
  extends: .js_test_template
  stage: test
  script:
    - yarn run test

ruby tests:
  extends: .ruby_test_template
  stage: test
  script:
    - bundle exec rails test